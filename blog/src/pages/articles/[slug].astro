---
import Layout from '../../layouts/Layout.astro';
import Navbar from '../../components/ui/Navbar';
import TableOfContents from '../../components/ui/TableOfContents';
import { getAllArticles } from '../../utils/content';
import { marked } from 'marked';
import hljs from 'highlight.js';

export async function getStaticPaths() {
  const articlesPtBr = getAllArticles('pt-BR');
  const articlesEnUs = getAllArticles('en-US');
  
  return [
    ...articlesPtBr.map(article => ({
      params: { slug: article.slug },
      props: { article, lang: 'pt-BR' }
    })),
    ...articlesEnUs.map(article => ({
      params: { slug: `en-${article.slug}` },
      props: { article, lang: 'en-US' }
    }))
  ];
}

const { article, lang } = Astro.props;

// Configurar marked com highlight.js
marked.setOptions({
  highlight: function(code, lang) {
    if (lang && hljs.getLanguage(lang)) {
      try {
        return hljs.highlight(code, { language: lang }).value;
      } catch (err) {}
    }
    return hljs.highlightAuto(code).value;
  },
});

const htmlContent = marked(article.content);

// Schema.org JSON-LD
const schema = {
  "@context": "https://schema.org",
  "@type": "Article",
  "headline": article.title,
  "description": article.excerpt,
  "author": {
    "@type": "Person",
    "name": "Matheus Ricardo"
  },
  "datePublished": article.date,
  "publisher": {
    "@type": "Organization",
    "name": "CommitToLearn",
    "logo": {
      "@type": "ImageObject",
      "url": "https://committolearn.com/logo.png"
    }
  }
};
---

<Layout 
  title={`${article.title} - CommitToLearn`} 
  lang={lang}
  description={article.excerpt}
  article={true}
  publishedTime={article.date}
>
  <Navbar client:load currentLang={lang} />
  
  <main class="pt-16">
    <!-- Hero -->
    <section class="border-b border-gray-800 py-16 px-4">
      <div class="max-w-4xl mx-auto">
        {article.category && (
          <span class="inline-block px-3 py-1 text-sm font-medium text-gray-400 border border-gray-800 mb-4">
            {article.category}
          </span>
        )}
        <h1 class="text-4xl md:text-5xl font-bold mb-4 text-white">
          {article.title}
        </h1>
        <div class="flex items-center gap-4 text-gray-500 text-sm">
          {article.date && (
            <span>
              {new Date(article.date).toLocaleDateString(lang, { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
              })}
            </span>
          )}
          {article.readingTime && (
            <>
              <span>•</span>
              <span>{article.readingTime}</span>
            </>
          )}
        </div>
      </div>
    </section>

    <!-- Article Content -->
    <article class="max-w-7xl mx-auto px-4 py-12">
      <div class="flex gap-8">
        <!-- Main Content -->
        <div class="flex-1 min-w-0">
          <!-- Back button -->
          <div class="mb-8">
            <a
              href="/articles"
              class="inline-flex items-center px-6 py-3 border border-gray-700 text-gray-300 hover:bg-gray-900 transition-colors text-sm"
            >
              <svg class="w-4 h-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
              </svg>
              {lang === 'pt-BR' ? 'Voltar para Artigos' : 'Back to Articles'}
            </a>
          </div>

          <div class="prose prose-lg prose-invert max-w-none">
            <div class="border border-gray-800 p-8 md:p-12 bg-black">
              <div set:html={htmlContent} class="markdown-content" />
            </div>
          </div>

          <!-- Comments Section -->
          <section class="mt-16 border-t border-gray-800 pt-12">
            <h2 class="text-2xl font-bold text-white mb-6">
              {lang === 'pt-BR' ? 'Comentários' : 'Comments'}
            </h2>
            <div class="bg-black border border-gray-800 p-8">
              <script src="https://giscus.app/client.js"
            data-repo="CommitToLearnn/CommitToLearn"
            data-repo-id="R_kgDOPF5-IA"
            data-category="General"
            data-category-id="DIC_kwDOPF5-IM4CyBev"
            data-mapping="pathname"
            data-strict="0"
            data-reactions-enabled="1"
            data-emit-metadata="0"
            data-input-position="bottom"
            data-theme="dark"
            data-lang={lang === 'pt-BR' ? 'pt' : 'en'}
            crossorigin="anonymous"
            async>
    </script>
            </div>
          </section>
        </div>

        <!-- Table of Contents -->
        <TableOfContents client:load />
      </div>
    </article>
  </main>

  <!-- Footer -->
  <footer class="py-12 px-4 border-t border-gray-800 mt-20">
    <div class="max-w-7xl mx-auto text-center">
      <div class="flex justify-center gap-4 mb-4">
        <a href="https://github.com/matheussricardoo" target="_blank" rel="noopener noreferrer" class="text-gray-500 hover:text-white transition-colors">
          <svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
            <path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/>
          </svg>
        </a>
        <a href="https://www.linkedin.com/in/matheus-ricardo-426452266/" target="_blank" rel="noopener noreferrer" class="text-gray-500 hover:text-white transition-colors">
          <svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
            <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
          </svg>
        </a>
      </div>
      <p class="text-gray-500 text-sm">
        © 2025 CommitToLearn
      </p>
    </div>
  </footer>
</Layout>

<script type="application/ld+json" set:html={JSON.stringify(schema)} />

<script is:inline>
  document.addEventListener('DOMContentLoaded', () => {
    // Adicionar botão de cópia a todos os blocos de código
    document.querySelectorAll('pre code').forEach((block) => {
      const pre = block.parentElement;
      if (!pre) return;
      
      // Criar wrapper para posicionar o botão
      const wrapper = document.createElement('div');
      wrapper.style.position = 'relative';
      pre.parentNode?.insertBefore(wrapper, pre);
      wrapper.appendChild(pre);
      
      // Criar botão de cópia
      const button = document.createElement('button');
      button.className = 'copy-code-button';
      button.textContent = 'Copiar';
      button.style.position = 'absolute';
      button.style.top = '0.5rem';
      button.style.right = '0.5rem';
      button.style.padding = '0.25rem 0.75rem';
      button.style.fontSize = '0.75rem';
      button.style.background = '#1f2937';
      button.style.color = '#9ca3af';
      button.style.border = '1px solid #374151';
      button.style.borderRadius = '0.25rem';
      button.style.cursor = 'pointer';
      button.style.transition = 'all 0.2s';
      
      button.addEventListener('mouseenter', () => {
        button.style.background = '#374151';
        button.style.color = '#ffffff';
      });
      
      button.addEventListener('mouseleave', () => {
        button.style.background = '#1f2937';
        button.style.color = '#9ca3af';
      });
      
      button.addEventListener('click', async () => {
        const code = block.textContent || '';
        await navigator.clipboard.writeText(code);
        button.textContent = 'Copiado!';
        button.style.color = '#10b981';
        setTimeout(() => {
          button.textContent = 'Copiar';
          button.style.color = '#9ca3af';
        }, 2000);
      });
      
      wrapper.appendChild(button);
    });
  });
</script>

<style is:global>
  .markdown-content {
    color: #d1d5db;
  }

  .markdown-content h1,
  .markdown-content h2,
  .markdown-content h3,
  .markdown-content h4 {
    color: #ffffff;
    margin-top: 2rem;
    margin-bottom: 1rem;
  }

  .markdown-content h1 {
    font-size: 2rem;
    border-bottom: 1px solid #374151;
    padding-bottom: 0.5rem;
  }

  .markdown-content h2 {
    font-size: 1.75rem;
  }

  .markdown-content h3 {
    font-size: 1.5rem;
  }

  .markdown-content p {
    margin-bottom: 1.5rem;
    line-height: 1.8;
  }

  .markdown-content code {
    background: #111111;
    color: #9ca3af;
    padding: 0.2rem 0.4rem;
    border-radius: 0.25rem;
    font-size: 0.9em;
    border: 1px solid #1f2937;
  }

  .markdown-content pre {
    background: #0d1117 !important;
    padding: 1.5rem;
    padding-top: 2.5rem;
    border-radius: 0.5rem;
    overflow-x: auto;
    margin: 1.5rem 0;
    border: 1px solid #1f2937;
    position: relative;
  }

  .markdown-content pre code {
    background: none !important;
    padding: 0 !important;
    border: none !important;
    font-family: 'Courier New', monospace;
    font-size: 0.9em;
    line-height: 1.6;
    display: block;
  }

  /* Force syntax highlighting colors with maximum specificity */
  .markdown-content pre code span.hljs-comment,
  .markdown-content pre code span.hljs-quote,
  .markdown-content pre code .hljs-comment,
  .markdown-content pre code .hljs-quote {
    color: #8b949e !important;
    font-style: italic;
  }

  .markdown-content pre code span.hljs-keyword,
  .markdown-content pre code span.hljs-selector-tag,
  .markdown-content pre code span.hljs-literal,
  .markdown-content pre code span.hljs-type,
  .markdown-content pre code span.hljs-built_in,
  .markdown-content pre code .hljs-keyword,
  .markdown-content pre code .hljs-selector-tag,
  .markdown-content pre code .hljs-literal,
  .markdown-content pre code .hljs-type,
  .markdown-content pre code .hljs-built_in {
    color: #ff7b72 !important;
    font-weight: bold;
  }

  .markdown-content pre code span.hljs-string,
  .markdown-content pre code span.hljs-title,
  .markdown-content pre code span.hljs-section,
  .markdown-content pre code span.hljs-selector-class,
  .markdown-content pre code .hljs-string,
  .markdown-content pre code .hljs-title,
  .markdown-content pre code .hljs-section,
  .markdown-content pre code .hljs-selector-class {
    color: #a5d6ff !important;
  }

  .markdown-content pre code span.hljs-number,
  .markdown-content pre code span.hljs-meta,
  .markdown-content pre code .hljs-number,
  .markdown-content pre code .hljs-meta {
    color: #79c0ff !important;
  }

  .markdown-content pre code span.hljs-function,
  .markdown-content pre code span.hljs-params,
  .markdown-content pre code span.hljs-attr,
  .markdown-content pre code span.hljs-property,
  .markdown-content pre code .hljs-function,
  .markdown-content pre code .hljs-params,
  .markdown-content pre code .hljs-attr,
  .markdown-content pre code .hljs-property {
    color: #d2a8ff !important;
  }

  .markdown-content pre code span.hljs-variable,
  .markdown-content pre code span.hljs-name,
  .markdown-content pre code span.hljs-tag,
  .markdown-content pre code .hljs-variable,
  .markdown-content pre code .hljs-name,
  .markdown-content pre code .hljs-tag {
    color: #7ee787 !important;
  }

  .markdown-content pre code span.hljs-regexp,
  .markdown-content pre code span.hljs-link,
  .markdown-content pre code .hljs-regexp,
  .markdown-content pre code .hljs-link {
    color: #ffa657 !important;
  }

  .markdown-content pre code span.hljs-symbol,
  .markdown-content pre code span.hljs-bullet,
  .markdown-content pre code .hljs-symbol,
  .markdown-content pre code .hljs-bullet {
    color: #f0883e !important;
  }

  .markdown-content ul,
  .markdown-content ol {
    margin-bottom: 1.5rem;
    padding-left: 2rem;
  }

  .markdown-content li {
    margin-bottom: 0.5rem;
  }

  .markdown-content a {
    color: #9ca3af;
    text-decoration: underline;
  }

  .markdown-content a:hover {
    color: #ffffff;
  }

  .markdown-content blockquote {
    border-left: 3px solid #374151;
    padding-left: 1.5rem;
    margin: 1.5rem 0;
    font-style: italic;
    color: #9ca3af;
  }

  .markdown-content img {
    border-radius: 0.5rem;
    margin: 2rem auto;
    border: 1px solid #1f2937;
  }

  .markdown-content table {
    width: 100%;
    margin: 1.5rem 0;
    border-collapse: collapse;
  }

  .markdown-content th,
  .markdown-content td {
    border: 1px solid #374151;
    padding: 0.75rem;
    text-align: left;
  }

  .markdown-content th {
    background: #111111;
    font-weight: bold;
  }
</style>
